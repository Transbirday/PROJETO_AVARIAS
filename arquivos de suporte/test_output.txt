Creating test database for alias 'default'...

..F
======================================================================
FAIL: test_prejuizo_definition (app_avarias.tests_improvements.ImprovementTests.test_prejuizo_definition)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "C:\Users\Seguran√æa\Documents\Avarias_Projeto\app_avarias\tests_improvements.py", line 74, in test_prejuizo_definition
    self.assertContains(response, avaria.nota_fiscal)
AssertionError: False is not true : Couldn't find '222' in the following response
b'<!DOCTYPE html>\n<html lang="pt-br">\n\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Defini\xc3\xa7\xc3\xa3o de Preju\xc3\xadzo | Transbirday</title>\n    <!-- Bootstrap 5 CSS -->\n    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">\n    <!-- Bootstrap Icons -->\n    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">\n    <!-- Select2 CSS -->\n    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />\n    <link rel="stylesheet"\n        href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />\n    <!-- Custom CSS -->\n    \n    <style>\n        body {\n            background-color: #f8f9fa;\n        }\n\n        .sidebar {\n            min-height: 100vh;\n            background-color: #212529;\n            /* Dark Sidebar */\n        }\n\n        .nav-link {\n            color: rgba(255, 255, 255, 0.7);\n        }\n\n        .nav-link:hover,\n        .nav-link.active {\n            color: white;\n            background-color: rgba(255, 255, 255, 0.1);\n            border-radius: 5px;\n        }\n\n        .main-content {\n            padding: 20px;\n        }\n\n        /* Sidebar subgroups indentation */\n        .nav-subgroup {\n            margin-left: 1rem;\n            font-size: 0.9rem;\n        }\n    </style>\n</head>\n\n<body>\n    \n    <div class="container-fluid">\n        <div class="row">\n            <!-- Sidebar -->\n            <div class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">\n                <div class="position-sticky pt-3">\n                    <h5 class="text-white text-center mb-4">TRANSBIRDAY AVARIAS</h5>\n                    <ul class="nav flex-column">\n                        <!-- PAINEL DE CONTROLE -->\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/">\n                                <i class="bi bi-speedometer2 me-2"></i> Painel de Controle\n                            </a>\n                        </li>\n\n                        <!-- FLUXO DE AVARIAS -->\n                        <h6\n                            class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-white-50 text-uppercase">\n                            <span>Fluxo de Avarias</span>\n                        </h6>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/avarias/nova/">\n                                <i class="bi bi-plus-circle me-2"></i> Nova Avaria\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/avarias/?status=EM_ABERTO">\n                                <i class="bi bi-exclamation-triangle me-2"></i> Em Aberto\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/avarias/?status=AGUARDANDO_DEVOLUCAO">\n                                <i class="bi bi-hourglass-split me-2"></i> Aguardando Devolu\xc3\xa7\xc3\xa3o\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/avarias/?status=EM_ROTA_DEVOLUCAO">\n                                <i class="bi bi-truck me-2"></i> Rota de Devolu\xc3\xa7\xc3\xa3o\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link active"\n                                href="/avarias/definicao-prejuizo/">\n                                <i class="bi bi-cash-coin me-2"></i> Defini\xc3\xa7\xc3\xa3o de Preju\xc3\xadzo\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/avarias/pesquisa/">\n                                <i class="bi bi-search me-2"></i> Pesquisa Global\n                            </a>\n                        </li>\n\n                        <!-- CADASTROS -->\n                        <h6\n                            class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-white-50 text-uppercase">\n                            <span>Cadastros</span>\n                        </h6>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/condutores/">\n                                <i class="bi bi-people me-2"></i> Condutores\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/veiculos/">\n                                <i class="bi bi-truck-front me-2"></i> Ve\xc3\xadculos\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/produtos/">\n                                <i class="bi bi-box-seam me-2"></i> Produtos\n                            </a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link "\n                                href="/clientes/">\n                                <i class="bi bi-buildings me-2"></i> Clientes\n                            </a>\n                        </li>\n\n                        <!-- ADMIN -->\n                        \n                    </ul>\n                    <hr class="text-white">\n                    <div class="px-3">\n                        <span class="text-white small">Usu\xc3\xa1rio: testuser</span><br>\n                        <form action="/logout/" method="post" class="d-inline">\n                            <input type="hidden" name="csrfmiddlewaretoken" value="BLoZ8ZkRl028ZzEiHourl9jJDAafsZCKekqZ6I96Cvk1AwiYGTJVEA5WBnpMgRXr">\n                            <button type="submit"\n                                class="btn btn-link text-danger small text-decoration-none p-0 border-0">Sair</button>\n                        </form>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Main Content -->\n            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">\n                \n\n                \n<div class="row">\n    <div class="col-12">\n        <h2 class="mb-4 text-white p-2 rounded" style="background-color: #0dcaf0;">\n            <i class="bi bi-cash-coin me-2"></i> Defini\xc3\xa7\xc3\xa3o de Preju\xc3\xadzo (Log\xc3\xadstica Reversa Conclu\xc3\xadda)\n        </h2>\n\n        \n        <div class="card shadow-sm">\n            <div class="card-body p-0">\n                <div class="table-responsive">\n                    <table class="table table-hover table-striped mb-0 align-middle">\n                        <thead class="table-light">\n                            <tr>\n                                <th># ID</th>\n                                <th>Cria\xc3\xa7\xc3\xa3o</th>\n                                <th>Finaliza\xc3\xa7\xc3\xa3o</th>\n                                <th>Cliente</th>\n                                <th>Produto</th>\n                                <th>Valor NF</th>\n                                <th>NFD</th>\n                                <th>Motivo Devolu\xc3\xa7\xc3\xa3o</th>\n                                <th style="min-width: 200px;">Responsabilidade</th>\n                                <th>A\xc3\xa7\xc3\xa3o</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            \n                            <tr>\n                                <form method="post">\n                                    <input type="hidden" name="csrfmiddlewaretoken" value="BLoZ8ZkRl028ZzEiHourl9jJDAafsZCKekqZ6I96Cvk1AwiYGTJVEA5WBnpMgRXr">\n                                    <input type="hidden" name="avaria_id" value="1">\n                                    <td><strong>1</strong></td>\n                                    <td>05/02/2026</td>\n                                    <td>05/02/2026</td>\n                                    <td>Cliente Teste</td>\n                                    <td>Produto Teste</td>\n                                    <td>R$ None</td>\n                                    <td>-</td>\n                                    <td class="text-truncate" style="max-width: 150px;"\n                                        title="None">None</td>\n                                    <td>\n                                        <select name="responsavel_prejuizo" class="form-select form-select-sm" required>\n                                            <option value="" selected disabled>Selecione...</option>\n                                            <option value="TRANSBIRDAY">TRANSBIRDAY (Nossa Culpa)</option>\n                                            <option value="CLIENTE">CLIENTE (Cobrar Deles)</option>\n                                            <option value="TRANSPORTADORA_TERCEIRA">TRANSPORTADORA TERCEIRA</option>\n                                            <option value="OUTRO">OUTRO (Ver Obs)</option>\n                                        </select>\n                                    </td>\n                                    <td>\n                                        <button type="submit" class="btn btn-primary btn-sm">\n                                            <i class="bi bi-check-lg"></i> Salvar\n                                        </button>\n                                    </td>\n                                </form>\n                            </tr>\n                            \n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n        \n    </div>\n</div>\n\n            </main>\n        </div>\n    </div>\n    \n\n    <!-- jQuery -->\n    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>\n    <!-- Select2 JS -->\n    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>\n    <!-- Bootstrap JS Bundle -->\n    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>\n\n    <script>\n        // Global Select2 Initialization\n        $(document).ready(function () {\n            $(\'.select2\').select2({\n                theme: \'bootstrap-5\',\n                width: \'100%\'\n            });\n        });\n    </script>\n    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>\n    <script>\n        // Global Select2 Initialization & Masks\n        $(document).ready(function () {\n            $(\'.select2\').select2({\n                theme: \'bootstrap-5\',\n                width: \'100%\'\n            });\n\n            // Mascaras\n            $(\'.cpf-mask\').mask(\'000.000.000-00\');\n            $(\'.phone-mask\').mask(\'(00) 00000-0000\');\n            $(\'.cnpj-mask\').mask(\'00.000.000/0000-00\');\n        });\n    </script>\n    \n\n    <!-- Global Camera Modal -->\n    <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">\n        <div class="modal-dialog modal-lg">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <h5 class="modal-title" id="cameraModalLabel"><i class="bi bi-camera-fill"></i> Tirar Foto</h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body text-center">\n                    <div class="position-relative bg-dark rounded d-flex justify-content-center align-items-center"\n                        style="min-height: 400px;">\n                        <video id="cameraVideo" autoplay playsinline\n                            style="max-width: 100%; max-height: 500px; display: none;"></video>\n                        <canvas id="cameraCanvas" style="display: none; max-width: 100%; max-height: 500px;"></canvas>\n                        <div id="cameraLoading" class="text-white">\n                            <div class="spinner-border mb-2" role="status"></div>\n                            <div>Iniciando c\xc3\xa2mera...</div>\n                        </div>\n                    </div>\n                </div>\n                <div class="modal-footer justify-content-between">\n                    <div>\n                        <span class="badge bg-secondary" id="photoCounter">0 fotos capturadas</span>\n                    </div>\n                    <div>\n                        <button type="button" class="btn btn-secondary" id="btnRetake" style="display: none;">\n                            <i class="bi bi-arrow-counterclockwise"></i> Tentar Novamente\n                        </button>\n                        <button type="button" class="btn btn-primary btn-lg" id="btnCapture">\n                            <i class="bi bi-camera"></i> Capturar\n                        </button>\n                        <!-- New Multi-Photo Buttons -->\n                        <button type="button" class="btn btn-info text-white" id="btnAddMore" style="display: none;">\n                            <i class="bi bi-plus-circle"></i> Salvar & +1\n                        </button>\n                        <button type="button" class="btn btn-success" id="btnConfirm" style="display: none;">\n                            <i class="bi bi-check-lg"></i> Finalizar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        let videoStream = null;\n        let targetInputId = null;\n        let currentDataTransfer = new DataTransfer(); // Store files session-wise\n\n        const cameraModal = new bootstrap.Modal(document.getElementById(\'cameraModal\'));\n        const videoElement = document.getElementById(\'cameraVideo\');\n        const canvasElement = document.getElementById(\'cameraCanvas\');\n        const loadingElement = document.getElementById(\'cameraLoading\');\n        const photoCounter = document.getElementById(\'photoCounter\');\n\n        const btnCapture = document.getElementById(\'btnCapture\');\n        const btnRetake = document.getElementById(\'btnRetake\');\n        const btnAddMore = document.getElementById(\'btnAddMore\');\n        const btnConfirm = document.getElementById(\'btnConfirm\');\n\n        // Function called by the buttons in templates\n        window.openWebcam = function (inputId) {\n            targetInputId = inputId;\n            currentDataTransfer = new DataTransfer(); // Reset for new session\n\n            // Try to preserve existing files if input has them?\n            // Usually, triggering a new file selection (even natively) clears old ones unless handled carefully.\n            // Let\'s assume we start fresh or append. \n            // Better UX: Read existing files from input into DataTransfer so we don\'t lose them.\n            let input = document.getElementById(targetInputId) || document.querySelector(targetInputId);\n            if (input && input.files) {\n                for (let i = 0; i < input.files.length; i++) {\n                    currentDataTransfer.items.add(input.files[i]);\n                }\n            }\n            updateCounter();\n\n            resetModal();\n            cameraModal.show();\n            startCamera();\n        };\n\n        // Modal closed handler to stop camera\n        document.getElementById(\'cameraModal\').addEventListener(\'hidden.bs.modal\', function () {\n            stopCamera();\n        });\n\n        function startCamera() {\n            loadingElement.style.display = \'block\';\n            videoElement.style.display = \'none\';\n\n            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })\n                .then(function (stream) {\n                    videoStream = stream;\n                    videoElement.srcObject = stream;\n                    videoElement.onloadedmetadata = function (e) {\n                        loadingElement.style.display = \'none\';\n                        videoElement.style.display = \'block\';\n                        videoElement.play();\n                    };\n                })\n                .catch(function (err) {\n                    console.log("An error occurred: " + err);\n                    loadingElement.innerHTML = \'<i class="bi bi-exclamation-triangle text-danger fs-1"></i><br>Erro ao acessar a c\xc3\xa2mera.<br>Verifique as permiss\xc3\xb5es.\';\n                });\n        }\n\n        function stopCamera() {\n            if (videoStream) {\n                videoStream.getTracks().forEach(track => track.stop());\n                videoStream = null;\n            }\n        }\n\n        function resetModal() {\n            canvasElement.style.display = \'none\';\n            videoElement.style.display = \'block\';\n\n            btnCapture.style.display = \'inline-block\';\n            btnRetake.style.display = \'none\';\n            btnAddMore.style.display = \'none\';\n            btnConfirm.style.display = \'none\';\n\n            if (!videoStream) {\n                loadingElement.style.display = \'block\';\n            }\n        }\n\n        function updateCounter() {\n            photoCounter.textContent = currentDataTransfer.files.length + " foto(s) pronta(s)";\n        }\n\n        function savePhotoToTransfer(callback) {\n            canvasElement.toBlob(function (blob) {\n                const file = new File([blob], "cam_" + new Date().getTime() + ".png", { type: "image/png" });\n                currentDataTransfer.items.add(file);\n                updateCounter();\n\n                // Update Imput immediately? Yes, why not.\n                let input = document.getElementById(targetInputId) || document.querySelector(targetInputId);\n                if (input) {\n                    input.files = currentDataTransfer.files;\n                    // Trigger change event just to be safe (e.g. valid styling)\n                    // But maybe only trigger on finish? Let\'s trigger now so it feels responsive if there used \'change\' listeners.\n                }\n\n                if (callback) callback();\n            });\n        }\n\n        btnCapture.addEventListener(\'click\', function () {\n            // Draw\n            canvasElement.width = videoElement.videoWidth;\n            canvasElement.height = videoElement.videoHeight;\n            canvasElement.getContext(\'2d\').drawImage(videoElement, 0, 0);\n\n            // Switch view\n            videoElement.style.display = \'none\';\n            canvasElement.style.display = \'block\';\n\n            btnCapture.style.display = \'none\';\n\n            // Show Options\n            btnRetake.style.display = \'inline-block\';\n            btnAddMore.style.display = \'inline-block\';\n            btnConfirm.style.display = \'inline-block\';\n        });\n\n        btnRetake.addEventListener(\'click\', function () {\n            resetModal();\n        });\n\n        btnAddMore.addEventListener(\'click\', function () {\n            savePhotoToTransfer(function () {\n                // Flash success or just reset\n                resetModal(); // Back to camera\n            });\n        });\n\n        btnConfirm.addEventListener(\'click\', function () {\n            savePhotoToTransfer(function () {\n                let input = document.getElementById(targetInputId) || document.querySelector(targetInputId);\n                if (input) {\n                    input.dispatchEvent(new Event(\'change\', { bubbles: true }));\n                }\n                cameraModal.hide();\n            });\n        });\n    </script>\n\n</html>'

----------------------------------------------------------------------
Ran 3 tests in 2.100s

FAILED (failures=1)
Destroying test database for alias 'default'...

Found 3 test(s).
System check identified no issues (0 silenced).
